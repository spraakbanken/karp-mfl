<head>
<meta charset="UTF-8">
</head>
<h1>Documentation (<code>backend.py</code>)</h1>
<p>


<p>

<h2>Available calls to the backend</h2>
<table>
  <tr><td><b>Public calls:</b></td></tr>
  <tr><td> <a href="inflect">inflect </a></td> <td> </td></tr>
  <tr><td> <a href="inflectbklass">inflectbklass </a></td> <td> </td></tr>

</table>

<a name="inflect"/>
<h3>inflect</h3>
<p>
Available query parameters:
<table>
  <tr><td>'lexicon': </td><td> the lexicon</td></tr>
  <tr><td>'table':</td><td> the baseform </td></tr>
  <tr><td>'bklass':</td><td> the declination to use</td></tr>
  <tr><td>'pos':</td><td> the part of speech </td></tr>
  <tr><td>'pprior':</td><td> the pprior value to pextract: how much weight to give the frequency of the paradigms. Default: </td></tr>
</table>

<p>
Examples:
<ul>
  <li><pre>URL/inflect/?table=(word(|tag)?)*</pre>
  <li><a href="URL/inflect/?table=apa,apan"><pre>URL/inflect/?table=apa,apan</pre></a>
  <li><a href="URL/inflect/?table=apa,apan|pl indef nom"><pre>URL/inflect/?table=apa,apan|pl indef nom</pre></a>
  <li><a href="URL/inflect/?table=apa,apan|pl indef nom,apor"><pre>URL/inflect/?table=apa,apan|pl indef nom,apor</pre></a>
</ul>

<p>
Result:
<pre>
{
  "Results": [
    {
      "WordForms": [
        {
          "msd": "sg indef nom",
          "writtenForm": "apa"
        },
        ...
      ],
      "paradigm": "paradigm_name"
    }
  ],
  "analyzes": "1::msd=tag#1+iten::msd=tag\t0=apa,,1=apa" // shows variable instantiations and paradigm pattern for new paradigms
  "new": false/true
}
</pre>

<a name="inflectbklass"/>
<h3>inflectbklass</h3>
<p>
Available query parameters:
<table>
  <tr><td>'lexicon': </td><td> the lexicon</td></tr>
  <tr><td>'word':</td><td> the baseform </td></tr>
  <tr><td>'bklass':</td><td> the declination to use</td></tr>
  <tr><td>'pos':</td><td> the part of speech </td></tr>
</table>

<p>
Examples:
<ul>
  <li><a href="URL/inflectbklass/?word=apa&bklass=3"><pre>URL/inflectbklass/?word=apa&bklass=3</pre></a>
</ul>

<p>
Result:
<pre>
{
  "Results": [
    {
      "WordForms": [
        {
          "msd": "sg indef nom", 
          "writtenForm": "apa"
        }, 
        {
          "msd": "sg indef gen", 
          "writtenForm": "apas"
        }, 
        ...
        {
          "msd": "pl def gen", 
          "writtenForm": "apornas"
        }
      ], 
      "paradigm": "p6_br\u00e4nn\u00e4ssla"
    }, 
    {
      "WordForms": [...]
      }
}
</pre>




@app.route('/inflectlike')
def inflectlike():
    lexicon = request.args.get('lexicon', 'saldomp')
    word = request.args.get('word', '')
    pos = request.args.get('pos', 'nn')
    like = request.args.get('like')
    res = generate.test_paradigms(['%s\t%s' % (word, like)], paradigms, debug=True)
    print('res', res)
    ans = {"WordForms": helpers.format_simple_inflection(res)}
    print('ans', ans)
    return jsonify(ans)


# TODO fortsätt här
@app.route('/addtable')
def add_table():
    lexicon = request.args.get('lexicon', 'saldomp')
    table = request.args.get('table', '')
    pos = request.args.get('pos', 'nn')
    bklass = request.args.get('bklass')
    # get the paradigm
    lemgram = table[0].split('|')[0]
    ans = handle.inflect_table(table,
                               [paradigms, numexamples, lms, print_tables,
                                debug, pprior, choose])
    if ans['new']:
        print('add %s with paradigm %s' % (lemgram, ans['paradigm']))
        para = ans['paradigm']
        handle.add_paradigm(lemgram, para, paradigms)
    # else -> increase count for one and members
    else:
        score, para, v = ans['analyzes']
        print('add %s with analyze %s' % (para.name, v))
        handle.add_word_to_paradigm(lemgram, v, para)

    return jsonify({'added': str(para)})
    # send table to karp


@app.route('/search')
def searchtab():
    return render_template('search.html', infotext="mfl")


@app.route('/compile')
def compile():
    q = request.args.get('q', '')  # querystring
    s = request.args.get('s', '*')  # searchfield
    count, results = 0, []
    if s == "wf":
        res = helpers.karp_query('minientry',
                                 {'q': 'extended||and|baseformC|equals|%s||and|pos|startswith|nn' % q,
                                  'show': 'lemgram,bklass,paradigm,pos,inherent'})
        count = res['hits']['total']
        for r in res['hits']['hits']:
            results.append(r['_source'].get('FormRepresentations', [{}])[0])

        return render_template('wordlist.html', q=q, searchfield=s,
                               count=count, results=results)

    elif s == "paradigm":
        karp_q = 'extended||and|pos|startswith|nn'
        if q:
            logging.debug('q is %s' % q)
            karp_q += '||and|paradigm.search|equals|%s' % q
        res = helpers.karp_query('statistics',
                                 {'q': karp_q,
                                  'cardinality': True,
                                  'buckets': 'paradigm.bucket,bklass.bucket'})
        stats = res['aggregations']['q_statistics']
        buckets = stats['FormRepresentations.paradigm.raw']['buckets']
        count = 'X'  # TODO this is not the correct count

        return render_template('paralist.html', q=q, searchfield=s, count=count, results=buckets)

    elif s == "bklass":
        karp_q = 'extended||and|pos|startswith|nn'
        if q:
            karp_q += '||and|bklass|equals|%s' % q
        res = helpers.karp_query('statistics',
                                 {'q': karp_q,
                                  'cardinality': True,
                                  'buckets':'bklass.bucket.bucket,paradigm.bucket'})
        stats = res['aggregations']['q_statistics']
        buckets = stats['FormRepresentations.bklass']['buckets']
        count = 'X'  # TODO this is not the correct count

        return render_template('bklasslist.html', q=q, searchfield=s,
                               count=count, results=buckets)


logging.basicConfig(stream=sys.stderr, level='DEBUG')


@app.errorhandler(Exception)
def handle_invalid_usage(error):
    try:
        request.get_data()
        logging.debug('Error on url %s' % request.full_path)
        logging.exception(error)

        return error.message, 400
    except Exception:
        return "Oops, something went wrong\n", 500

if __name__ == '__main__':
    # sys.setdefaultencoding('utf8')
    parafile = sys.argv[1]
    # TODO how to set these?? i have increased pprior a lot, from 1.0 to 5.0
    print_tables, kbest, ngramorder, ngramprior, debug, pprior,choose = False, 10, 3, 0.01, False, 5.0, False
    paradigms, numexamples, lms = mp.build(parafile, ngramorder, ngramprior)
    parafile = open(parafile, encoding='utf8').readlines()
    app.run()
